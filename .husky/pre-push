#!/bin/sh

# Pre-push hook: Build, update manifest, and package dist
# This script runs before each push and:
# 1. Builds the project
# 2. Updates manifest.json version to match package.json
# 3. Creates dist.zip
# 4. Amends the last commit to include these changes

echo "Pre-push: Building and packaging..."

# Run build and package script
node scripts/build-and-package.js

# Check if there are changes to commit
if git diff --quiet manifest.json dist.zip 2>/dev/null; then
    echo "Pre-push: No changes to package"
else
    echo "Pre-push: Adding build artifacts to commit..."

    # Add the modified files
    git add manifest.json dist.zip

    # Amend the last commit to include the build artifacts
    # Using --no-verify to avoid triggering hooks again
    git commit --amend --no-edit --no-verify

    echo "Pre-push: Build artifacts added to commit"
fi

echo "Pre-push: Ready to push"
